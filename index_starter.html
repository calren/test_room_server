<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barebones MMORPG Client</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #4CAF50;
        }
        #gameCanvas {
            border: 2px solid #4CAF50;
            background-color: #000;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }
        #instructions {
            margin-top: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        #status {
            margin-top: 15px;
            font-size: 1.1em;
            color: #ffc107;
        }
    </style>
</head>
<body>

    <h1>MMORPG World</h1>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="status">Connecting to server...</div>
    <div id="instructions">
        <strong>Controls:</strong> Use Arrow Keys (Up, Down, Left, Right) to move your character.
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        const ws = new WebSocket('ws://localhost:8080');

        let players = {};
        const playerSize = 50;

        // Sprites will be received from the server
        let sprites = {};

        // Function to draw the game world
        function draw() {
            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw all players
            for (const id in players) {
                const player = players[id];
                ctx.font = `${playerSize - 10}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const spriteIcon = sprites[player.sprite] || sprites['default'];
                ctx.fillText(spriteIcon, player.x + playerSize / 2, player.y + playerSize / 2);

                // Draw player username label
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText(player.username || id, player.x + playerSize / 2, player.y + playerSize + 10);
            }
        }

        // Handle WebSocket connection opening
        ws.onopen = () => {
            statusDiv.textContent = 'Connected! Joining the world...';
            console.log('Connected to the server');

            // Request sprites from server first
            ws.send(JSON.stringify({ type: 'request_sprites' }));
        };

        // Handle incoming messages from the server
        ws.onmessage = event => {
            const data = JSON.parse(event.data);

            switch (data.type) {
                case 'sprites_response':
                    sprites = data.sprites;
                    // Now join the game with a random sprite
                    const spriteKeys = Object.keys(sprites);
                    const randomSprite = spriteKeys[Math.floor(Math.random() * spriteKeys.length)];
                    ws.send(JSON.stringify({ type: 'player_join', sprite: randomSprite, username: 'caren'}));
                    break;
                case 'world_state':
                    players = data.players;
                    statusDiv.textContent = `World joined! Players online: ${Object.keys(players).length}`;
                    break;
                case 'player_joined':
                    players[data.player.id] = data.player;
                    statusDiv.textContent = `Player ${data.player.username || data.player.id} joined! Players online: ${Object.keys(players).length}`;
                    break;
                case 'player_moved':
                    if (players[data.player.id]) {
                        players[data.player.id].x = data.player.x;
                        players[data.player.id].y = data.player.y;
                    }
                    break;
                case 'player_left':
                    const leftPlayer = players[data.playerId];
                    delete players[data.playerId];
                    statusDiv.textContent = `Player ${leftPlayer ? (leftPlayer.username || data.playerId) : data.playerId} left. Players online: ${Object.keys(players).length}`;
                    break;
            }
            // Redraw the world with the new state
            draw();
        };

        // Handle connection closing
        ws.onclose = () => {
            statusDiv.textContent = 'Disconnected from server. Please refresh to reconnect.';
            console.log('Disconnected from server');
        };

        // Handle connection errors
        ws.onerror = error => {
            statusDiv.textContent = 'Error connecting to the server.';
            console.error('WebSocket Error:', error);
        };

        // TODO: Handle keyboard input for movement up. down, left, right
        document.addEventListener('keydown', e => {
            let direction = null;
            switch (e.key) {
                case 'ArrowUp':
                    direction = 'up';
                    break;
                case 'ArrowDown':
                    direction = 'down';
                    break;
                case 'ArrowLeft':
                    direction = 'left';
                    break;
                case 'ArrowRight':
                    direction = 'right';
                    break;
            }
            if (direction) {
                // Prevent default browser action for arrow keys (like scrolling)
                e.preventDefault();
                // Send the move command to the server
                ws.send(JSON.stringify({ type: 'player_move', direction }));
            }
        });
    </script>

</body>
</html>

